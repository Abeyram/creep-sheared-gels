#Leave this at 1 since beta epsilon is then the morse well depth
variable run_temp equal 1

units		lj 
atom_style	atomic 
atom_modify	map array 


# read interactions
pair_style	hybrid/overlay morse 1.4 dpd/tstat 1.0 1.0 2.5 34387
read_data ${file_name}	
pair_coeff * * dpd/tstat 100 1
pair_modify	shift yes
comm_modify vel yes

minimize 	1e-10 1e-10 3000 3000

change_box all triclinic
velocity all create 1 1234

variable L equal xhi-xlo
print "Box size $L"

timestep 0.001

dump 		dumpatom  all atom 500 shear-dump.atom.gz
dump_modify	dumpatom sort id first yes

thermo 1000
thermo_style custom step temp c_deform_temp press pxy xy pe v_rate

## Do Equilibration

fix equilibrate all nvt temp ${run_temp} ${run_temp} 1
run 100000
unfix equilibrate

## Set up Shear

compute		deform_temp all temp/deform
compute		deform_pressure all pressure deform_temp
reset_timestep 0

run 0

variable sigmaxy equal  -c_deform_pressure[4] #Get the xy stress
variable sigma0 equal 0.0001      # Target stress
variable damp equal 1.0         # Damping parameter
variable dt equal 0.0083        # Timestep of integration
variable Ly equal 5             # Magnitude of the shear

fix 1 all nve
# Every step deform the box by v_deform amount at rate v_rate. 
fix 2 all deform 1 xy variable v_deform v_rate remap x

variable deform equal f_oldrate*${dt}+f_old_deform
variable rate equal f_oldrate+${damp}*(${sigma0}-v_sigmaxy)*${dt}*${Ly}

# Compute the deform and rate variables every step
fix     old_deform all ave/time 1 1 1 v_deform
fix     oldrate all ave/time 1 1 1 v_rate

## Do production

run 100000


